<!DOCTYPE html>
<!--
@game-meta
{
  "id": "school-dance",
  "title": "êµì‹¤ì—ì„œ ì¶¤ì„!",
  "emoji": "ğŸ’ƒ",
  "category": "ì„œë°”ì´ë²Œ",
  "description": "ì„ ìƒë‹˜ì´ ìˆ˜í•™ ë¬¸ì œë¥¼ í’€ ë•Œ ëª°ë˜ ì¶¤ì„ ì¶”ì„¸ìš”! ì •ë‹µì„ ì“°ê³  ë’¤ëŒì•„ë³¼ ë•Œ ë©ˆì¶”ì§€ ëª»í•˜ë©´ íƒˆë½!",
  "features": ["ğŸ« êµì‹¤ í…Œë§ˆ", "ğŸ•º ëŒ„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜", "ğŸ”¢ ìˆ˜í•™ ë¬¸ì œ ëª¨ë“œ"],
  "color": "mugunghwa",
  "badge": "NEW",
  "version": "1.7.0",
  "updated": "2025-12-28",
  "author": {
    "name": "Euiyun Edwin Kim",
    "email": "geniuskey@gmail.com",
    "github": "geniuskey"
  },
  "urls": {
    "service": "https://geniuskey.github.io/lottery/school-dance/",
    "repository": "https://github.com/geniuskey/lottery"
  },
  "license": "MIT",
  "copyright": "Â© 2025 Euiyun Edwin Kim."
}
@end-game-meta
-->
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>êµì‹¤ì—ì„œ ì¶¤ì„! - ì¶”ì²¨ ê²Œì„ í¬í„¸</title>

  <!-- SEO ê¸°ë³¸ -->
  <meta name="description" content="ì„ ìƒë‹˜ ëª°ë˜ ì¶¤ì„ ì¶”ê³  ìµœí›„ì˜ ëŒ„ì‹±í€¸/í‚¹ì´ ë˜ì„¸ìš”! ë¬´ê¶í™” ê½ƒì´ í”¼ì—ˆìŠµë‹ˆë‹¤ ë°©ì‹ì˜ ì˜¨ë¼ì¸ ì„œë°”ì´ë²Œ ì¶”ì²¨ ê²Œì„.">
  <meta name="author" content="Euiyun Edwin Kim">
  <meta name="keywords" content="ë¬´ê¶í™” ê½ƒì´ í”¼ì—ˆìŠµë‹ˆë‹¤, ëŒ„ìŠ¤ ê²Œì„, êµì‹¤ì—ì„œ ì¶¤ì„, ì„œë°”ì´ë²Œ ê²Œì„, ì¶”ì²¨ ê²Œì„, ì˜¨ë¼ì¸ ì¶”ì²¨, ëœë¤ ì„ íƒ">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ì¶”ì²¨ ê²Œì„ í¬í„¸">
  <meta property="og:title" content="ğŸ’ƒ êµì‹¤ì—ì„œ ì¶¤ì„! - ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ëŒ„ìŠ¤ ì¶”ì²¨">
  <meta property="og:description" content="ì„ ìƒë‹˜ì´ ë’¤ëŒì•„ë³´ëŠ” ìˆœê°„, ë‹¹ì‹ ì˜ ì¶¤ì„ ë©ˆì¶”ì„¸ìš”! ê¸´ì¥ë°±ë°° ì„œë°”ì´ë²Œ ì¶”ì²¨.">
  <meta property="og:url" content="https://geniuskey.github.io/lottery/school-dance/">
  <meta property="og:image" content="https://geniuskey.github.io/lottery/og-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ğŸ’ƒ êµì‹¤ì—ì„œ ì¶¤ì„! - ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ëŒ„ìŠ¤ ì¶”ì²¨">
  <meta name="twitter:description" content="ì„ ìƒë‹˜ì´ ë’¤ëŒì•„ë³´ëŠ” ìˆœê°„, ë‹¹ì‹ ì˜ ì¶¤ì„ ë©ˆì¶”ì„¸ìš”! ê¸´ì¥ë°±ë°° ì„œë°”ì´ë²Œ ì¶”ì²¨.">
  <meta name="twitter:image" content="https://geniuskey.github.io/lottery/og-image.png">

  <!-- ì¶”ê°€ SEO -->
  <link rel="canonical" href="https://geniuskey.github.io/lottery/school-dance/">
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’ƒ</text></svg>">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#1a1a2e">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      height: 100vh;
      display: flex;
      padding: 20px;
      gap: 20px;
    }

    /* Sidebar Standard Styles */
    .sidebar {
      width: 300px;
      min-width: 280px;
      max-width: 300px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      z-index: 1000;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .sidebar h2 {
      color: #fff;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .help-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s;
    }

    .help-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .sidebar label {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar textarea {
      width: 100%;
      height: 80px;
      padding: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      resize: none;
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .sidebar textarea:focus {
      border-color: #ff4b2b;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider-container input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 75, 43, 0.4);
    }

    .slider-value {
      min-width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #ff4b2b;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-start {
      background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%);
      color: #fff;
    }

    .btn-start:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(255, 75, 43, 0.4);
    }

    .btn-start:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.3);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-reset {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      flex: 0 0 54px;
    }

    .ranking-board {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 16px;
      padding: 12px;
      overflow-y: auto;
      min-height: 0;
    }

    .ranking-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fff;
    }

    .ranking-item.winner {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 179, 71, 0.3) 100%);
      border: 1px solid rgba(255, 215, 0, 0.5);
    }

    .ranking-item.eliminated {
      background: rgba(255, 107, 107, 0.15);
      color: #ff8a8a;
      justify-content: space-between;
    }

    .ranking-item .reason-text {
      font-size: 0.7rem;
      opacity: 0.8;
      white-space: nowrap;
    }

    /* Footer Standard Styles */
    .sidebar-footer {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
    }

    .icon-btn:hover {
      background: rgba(255, 75, 43, 0.3);
      color: #ff4b2b;
      transform: translateY(-2px);
    }

    .icon-btn[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      white-space: nowrap;
      margin-bottom: 8px;
    }

    /* Game Area Styles */
    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .classroom {
      flex: 1;
      border-radius: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      background: #C4A484;
    }

    .round-counter {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 6px 20px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 1rem;
      z-index: 1000;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
    }

    .copyright {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.3);
      pointer-events: none;
      user-select: none;
      z-index: 1000;
    }

    .students-area {
      position: absolute;
      top: 15%;
      left: 5%;
      right: 5%;
      height: 55%;
      display: grid;
      justify-items: center;
      align-content: start;
      gap: 30px;
      z-index: 10;
    }

    .bottom-stage {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20%;
      background: linear-gradient(180deg, #98D8C8 0%, #7fc8b8 100%);
      border-top: 5px solid #8B4513;
      z-index: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 10px;
    }

    .speech-bubble {
      position: absolute;
      bottom: 30%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 15px 30px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      font-size: clamp(1.2rem, 2vw, 2rem);
      font-weight: 800;
      color: #333;
      z-index: 600;
      min-width: 250px;
      text-align: center;
      display: none;
      white-space: pre-line;
    }

    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 15px solid #fff;
    }

    /* Teacher */
    .teacher-container {
      position: absolute;
      top: -70px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 130px;
      z-index: 100;
    }

    .teacher {
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-style: preserve-3d;
    }

    .teacher.watching {
      transform: rotateY(180deg);
    }

    .teacher-front,
    .teacher-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .teacher-back {
      transform: rotateY(0deg);
    }

    .teacher-front {
      transform: rotateY(180deg);
    }

    .t-head {
      font-size: 50px;
      margin-bottom: -10px;
      z-index: 2;
    }

    .t-body {
      width: 60px;
      height: 70px;
      background: #2c3e50;
      border-radius: 12px 12px 5px 5px;
      position: relative;
    }

    .t-arm {
      width: 14px;
      height: 25px;
      background: #2c3e50;
      position: absolute;
      top: 10px;
      border-radius: 7px;
      transform-origin: top center;
    }

    .t-forearm {
      width: 14px;
      height: 25px;
      background: #2c3e50;
      position: absolute;
      top: 20px;
      left: 0;
      border-radius: 7px;
      transform-origin: top center;
    }

    .t-arm.l {
      left: -12px;
    }

    .t-arm.r {
      right: -12px;
    }

    .teacher-back .t-arm.r {
      animation: writing 0.8s infinite alternate;
    }

    .teacher-back .t-arm.r .t-forearm {
      animation: writing-forearm 0.8s infinite alternate;
    }

    @keyframes writing {
      from {
        transform: rotate(-10deg);
      }

      to {
        transform: rotate(-40deg);
      }
    }

    @keyframes writing-forearm {
      from {
        transform: rotate(-10deg);
      }

      to {
        transform: rotate(-60deg);
      }
    }

    /* Students */
    .student {
      position: relative;
      width: 80px;
      height: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      --x-off: 0px;
      --y-off: 0px;
    }

    .student-name {
      position: absolute;
      top: -25px;
      font-size: 0.8rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.7);
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 500;
      transform: translate(var(--x-off), var(--y-off));
    }

    .chair {
      position: absolute;
      top: 25px;
      font-size: 40px;
      z-index: 5;
      opacity: 0.8;
    }

    .char {
      width: 50px;
      height: 80px;
      position: relative;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      margin-top: 10px;
      transform: translate(var(--x-off), var(--y-off));
    }

    .c-head {
      width: 32px;
      height: 32px;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 9px;
      z-index: 5;
    }

    .c-body {
      width: 26px;
      height: 30px;
      background: var(--color, #3498db);
      border-radius: 6px;
      position: absolute;
      top: 30px;
      left: 12px;
    }

    .c-arm {
      width: 8px;
      height: 15px;
      background: var(--color, #3498db);
      position: absolute;
      top: 32px;
      border-radius: 4px;
      transform-origin: top center;
      transition: transform 0.3s ease;
    }

    .c-forearm {
      width: 8px;
      height: 15px;
      background: var(--color, #3498db);
      position: absolute;
      top: 12px;
      left: 0;
      border-radius: 4px;
      transform-origin: top center;
    }

    .c-arm.l {
      left: 4px;
    }

    .c-arm.r {
      right: 4px;
    }

    .c-leg {
      width: 9px;
      height: 15px;
      background: #333;
      position: absolute;
      top: 55px;
      border-radius: 4px;
      transform-origin: top center;
    }

    .c-shin {
      width: 9px;
      height: 15px;
      background: #333;
      position: absolute;
      top: 12px;
      left: 0;
      border-radius: 4px;
      transform-origin: top center;
    }

    .c-leg.l {
      left: 13px;
    }

    .c-leg.r {
      right: 13px;
    }

    .desk-group {
      position: absolute;
      bottom: 5px;
      width: 70px;
      height: 45px;
      z-index: 200;
      pointer-events: none;
    }

    .desk-top {
      width: 70px;
      height: 10px;
      background: #DEB887;
      border: 2px solid #C4954B;
      border-radius: 4px;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .desk-leg {
      width: 4px;
      height: 35px;
      background: #8B4513;
      position: absolute;
      top: 8px;
    }

    .desk-leg.l {
      left: 5px;
    }

    .desk-leg.r {
      right: 5px;
    }

    /* Target Mark */
    .target-mark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(calc(-50% + var(--x-off)), calc(-50% + var(--y-off)));
      width: 100px;
      height: 100px;
      border: 4px solid #ff4b2b;
      border-radius: 50%;
      display: none;
      z-index: 600;
      pointer-events: none;
    }

    .target-mark::before,
    .target-mark::after {
      content: '';
      position: absolute;
      background: #ff4b2b;
    }

    .target-mark::before {
      width: 120%;
      height: 2px;
      top: 50%;
      left: -10%;
    }

    .target-mark::after {
      width: 2px;
      height: 120%;
      top: -10%;
      left: 50%;
    }

    .student.caught .target-mark {
      display: block;
      animation: pulse-target 0.5s infinite alternate;
    }

    .student.caught .chat-bubble,
    .student.caught .sleep-bubble {
      display: none !important;
    }

    .student.caught .char {
      z-index: 150;
    }

    .student.caught .char * {
      animation-play-state: paused !important;
    }

    @keyframes pulse-target {
      from {
        transform: translate(calc(-50% + var(--x-off)), calc(-50% + var(--y-off))) scale(1);
        opacity: 1;
      }

      to {
        transform: translate(calc(-50% + var(--x-off)), calc(-50% + var(--y-off))) scale(1.2);
        opacity: 0.6;
      }
    }

    /* Student States */
    .student.dancing {
      --x-off: 45px;
      --y-off: -20px;
    }

    .student.dancing .char {
      scale: 1.1;
      transform-origin: center center;
      animation: body-sway var(--dur, 0.3s) infinite alternate;
    }

    @keyframes body-sway {
      from {
        transform: translate(calc(var(--x-off) - 3px), var(--y-off)) rotate(-3deg);
      }

      to {
        transform: translate(calc(var(--x-off) + 3px), var(--y-off)) rotate(3deg);
      }
    }

    .student.dancing .c-arm.l {
      animation: intense-wave-l var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-al, 0s);
    }

    .student.dancing .c-arm.r {
      animation: intense-wave-r var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-ar, 0s);
    }

    .student.dancing .c-arm.l .c-forearm {
      animation: forearm-wave-l var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-f, 0s);
    }

    .student.dancing .c-arm.r .c-forearm {
      animation: forearm-wave-r var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-f, 0s);
    }

    .student.dancing .c-leg.l {
      animation: intense-kick-l var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-ll, 0s);
    }

    .student.dancing .c-leg.r {
      animation: intense-kick-r var(--dur, 0.3s) infinite alternate-reverse;
      animation-delay: var(--del-lr, 0s);
    }

    .student.dancing .c-leg.l .c-shin {
      animation: shin-kick-l var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-s, 0s);
    }

    .student.dancing .c-leg.r .c-shin {
      animation: shin-kick-r var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-s, 0s);
    }

    .student.dancing .c-head {
      animation: head-bob var(--dur, 0.3s) infinite alternate;
      animation-delay: var(--del-h, 0s);
    }

    /* Caught State */
    .student.eliminated .char {
      transform: translate(0, 0);
      z-index: 10;
    }

    .student.eliminated .c-arm.l {
      transform: rotate(160deg);
    }

    .student.eliminated .c-arm.r {
      transform: rotate(-160deg);
    }

    .student.eliminated .c-arm.l .c-forearm {
      transform: rotate(20deg);
    }

    .student.eliminated .c-arm.r .c-forearm {
      transform: rotate(-20deg);
    }

    .student.eliminated .c-head {
      animation: apology-bob 0.4s infinite alternate;
    }

    @keyframes forearm-wave-l {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(100deg);
      }
    }

    @keyframes forearm-wave-r {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(-100deg);
      }
    }

    @keyframes shin-kick-l {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(-70deg);
      }
    }

    @keyframes shin-kick-r {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(70deg);
      }
    }

    @keyframes apology-bob {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(5px);
      }
    }

    .apology-bubble {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: bold;
      border: 1px solid #ccc;
      display: none;
      z-index: 600;
      white-space: nowrap;
    }

    .student.eliminated .apology-bubble {
      display: block;
    }

    .chat-bubble {
      position: absolute;
      top: -45px;
      left: 50%;
      transform: translateX(-50%);
      background: #e1f5fe;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: bold;
      border: 1px solid #03a9f4;
      display: none;
      z-index: 600;
      white-space: nowrap;
      color: #0277bd;
    }

    .student.chatting .chat-bubble {
      display: block;
      animation: bubble-float 1s infinite alternate;
    }

    .sleep-bubble {
      position: absolute;
      top: -45px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff9c4;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: bold;
      border: 1px solid #fbc02d;
      display: none;
      z-index: 600;
      white-space: nowrap;
      color: #f57f17;
    }

    .student.sleeping .sleep-bubble {
      display: block;
      animation: bubble-float 2s infinite alternate;
    }

    @keyframes bubble-float {
      from {
        transform: translateX(-50%) translateY(0);
      }

      to {
        transform: translateX(-50%) translateY(-5px);
      }
    }

    /* Student Special States */
    .student.chatting .c-head {
      z-index: 20;
    }

    .student.chat-left {
      --x-off: -10px;
    }

    .student.chat-left .c-head {
      transform: rotate(-30deg);
    }

    .student.chat-right {
      --x-off: 10px;
    }

    .student.chat-right .c-head {
      transform: rotate(30deg);
    }

    .student.sleeping .char {
      transform: translateY(5px);
    }

    .student.sleeping .c-head {
      animation: sleep-breath 2s infinite ease-in-out;
    }

    @keyframes sleep-breath {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(3px);
      }
    }

    @keyframes intense-wave-l {
      from {
        transform: rotate(30deg);
      }

      to {
        transform: rotate(170deg);
      }
    }

    @keyframes intense-wave-r {
      from {
        transform: rotate(-30deg);
      }

      to {
        transform: rotate(-170deg);
      }
    }

    @keyframes intense-kick-l {
      from {
        transform: rotate(-10deg);
      }

      to {
        transform: rotate(70deg);
      }
    }

    @keyframes intense-kick-r {
      from {
        transform: rotate(10deg);
      }

      to {
        transform: rotate(-70deg);
      }
    }

    @keyframes head-bob {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-5px) rotate(10deg);
      }
    }

    /* Certificate Styles */
    .winner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      backdrop-filter: blur(10px);
    }

    .certificate {
      background: #fff;
      width: 90%;
      max-width: 600px;
      padding: 40px;
      border: 15px double #d4af37;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 50px rgba(212, 175, 55, 0.1);
      text-align: center;
      position: relative;
      color: #333;
    }

    .certificate::before {
      content: 'ğŸ–ï¸';
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 40px;
      opacity: 0.2;
    }

    .cert-title {
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 15px;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
      display: inline-block;
      padding-bottom: 5px;
    }

    .cert-award-name {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .cert-names {
      font-size: 1.2rem;
      margin-bottom: 30px;
      font-weight: bold;
      color: #000;
    }

    .cert-content {
      font-size: 1.1rem;
      line-height: 1.8;
      text-align: justify;
      margin-bottom: 40px;
      word-break: keep-all;
    }

    .cert-date {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .cert-footer {
      font-size: 1.3rem;
      font-weight: bold;
      margin-top: 20px;
    }

    .cert-btn {
      margin-top: 30px;
      padding: 10px 40px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .cert-btn:hover {
      background: #555;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: #1a1a2e;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 32px;
      border-radius: 24px;
      max-width: 500px;
      width: 90%;
      color: #fff;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-content h3 {
      margin-bottom: 16px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-content p {
      line-height: 1.6;
      margin-bottom: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-content ul {
      margin-left: 20px;
      margin-bottom: 20px;
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-close-btn {
      width: 100%;
      padding: 12px;
      background: #ff4b2b;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      z-index: 3000;
      animation: toast-in 0.3s ease;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Custom Scrollbar */
    .sidebar::-webkit-scrollbar,
    .ranking-board::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track,
    .ranking-board::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .ranking-board::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .sidebar::-webkit-scrollbar-thumb:hover,
    .ranking-board::-webkit-scrollbar-thumb:hover {
      background: #ff4b2b;
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
        padding: 10px;
        gap: 10px;
      }

      .sidebar {
        width: 100%;
        max-width: 100%;
        height: auto;
        max-height: 45vh;
        overflow-y: auto;
      }

      .game-area {
        flex: 1;
      }

      .teacher-container {
        width: 70px;
        height: 90px;
        top: -50px;
      }

      .t-head {
        font-size: 35px;
      }

      .t-body {
        width: 40px;
        height: 50px;
      }

      .speech-bubble {
        font-size: 1rem;
        min-width: 180px;
      }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>ğŸ’ƒ êµì‹¤ì—ì„œ ì¶¤ì„!</h2>
      <button class="help-btn" id="helpBtn">?</button>
    </div>

    <div class="settings-group">
      <label for="participants">ì°¸ì—¬ì</label>
      <textarea id="participants" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œ)\nì˜ˆ: ì² ìˆ˜, ì˜í¬*3, ë¯¼ìˆ˜">ì˜ìˆ˜, ì˜í˜¸, ì˜ì‹, ì˜ì² , ê´‘ìˆ˜, ìƒì² </textarea>
    </div>

    <div class="settings-group">
      <label>ğŸ† ìµœì¢… ìƒì¡´ì ìˆ˜</label>
      <div class="slider-container">
        <input type="range" id="winnerCount" min="1" max="10" value="1">
        <div class="slider-value" id="winnerValue">1</div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-start" id="startBtn">ğŸ® ì‹œì‘</button>
      <button class="btn btn-reset" id="resetBtn">â†º</button>
    </div>

    <div class="ranking-board">
      <div class="ranking-list" id="rankingList">
        <div style="color:rgba(255,255,255,0.4);text-align:center;padding:20px;">ì°¸ì—¬ìë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      </div>
    </div>

    <div class="sidebar-footer">
      <a href="https://geniuskey.github.io/lottery/" class="icon-btn" data-tooltip="ì¶”ì²¨ í¬íƒˆ í™ˆ">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </a>
      <button class="icon-btn" id="copyResultBtn" data-tooltip="ê²°ê³¼ ë³µì‚¬">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
      <a href="https://github.com/geniuskey/lottery" target="_blank" class="icon-btn" data-tooltip="GitHub ì €ì¥ì†Œ">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z">
          </path>
        </svg>
      </a>
      <a href="https://buymeacoffee.com/euiyun" target="_blank" class="icon-btn" data-tooltip="ì»¤í”¼ ì‚¬ì£¼ê¸° â˜•">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.081 1.156.147 1.737.158 2.48.043 4.966-.096 7.447-.177.179-.005.301.035.405.16.065.078.137.204.159.286.073.302.14.606.225.908.012.044.042.108.03.146zM5.946 5.972c-.039.133-.086.27-.126.407-.191.659-.408 1.32-.606 1.987-.26.875-1.02 1.582-2.0 1.708-1.086.14-2.13-.21-2.807-1.145-.258-.355-.405-.834-.41-1.283-.007-.597.161-1.184.338-1.753.157-.504.331-1.006.503-1.506.172-.5.44-.991.804-1.396.487-.541 1.21-.79 1.912-.877C5.172 1.866 6.818 3.046 5.946 5.972z">
          </path>
        </svg>
      </a>
    </div>
  </aside>

  <main class="game-area">
    <div class="classroom" id="classroom">
      <div id="roundCounter" class="round-counter">ROUND 1</div>
      <div class="students-area" id="studentsArea"></div>

      <div id="speechBubble" class="speech-bubble"></div>

      <div class="bottom-stage">
        <div class="teacher-container">
          <div class="teacher" id="teacher">
            <div class="teacher-back">
              <div class="t-head">ğŸ˜‘</div>
              <div class="t-body">
                <div class="t-arm r">
                  <div class="t-forearm"></div>
                </div>
              </div>
            </div>
            <div class="teacher-front">
              <div class="t-head">ğŸ§</div>
              <div class="t-body">
                <div class="t-arm l">
                  <div class="t-forearm"></div>
                </div>
                <div class="t-arm r">
                  <div class="t-forearm"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="copyright">Â© 2025 Euiyun Edwin Kim.</div>
    </div>
  </main>

  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal-content">
      <h3>â“ ê²Œì„ ë°©ë²•</h3>
      <p>ì„ ìƒë‹˜ì´ ìˆ˜í•™ ë¬¸ì œë¥¼ í‘¸ëŠ” ë™ì•ˆ ëª°ë˜ ì¶¤ì„ ì¶”ëŠ” ì„œë°”ì´ë²Œ ê²Œì„ì…ë‹ˆë‹¤!</p>
      <ul>
        <li>ì„ ìƒë‹˜ì´ ì¹ íŒì„ ë³´ê³  ìˆì„ ë•Œ í•™ìƒë“¤ì´ ì¶¤ì„ ì¶¥ë‹ˆë‹¤.</li>
        <li>ë¬¸ì œê°€ í’€ë¦¬ê³  <strong>'='</strong> ê¸°í˜¸ê°€ ë‚˜íƒ€ë‚˜ë©´ ëˆˆì¹˜ë¥¼ ë³´ë©° ìë¦¬ì— ì•‰ì•„ì•¼ í•©ë‹ˆë‹¤.</li>
        <li>ì„ ìƒë‹˜ì´ ë’¤ë¥¼ ëŒì•„ë´¤ì„ ë•Œ ì™„ì „íˆ ì•‰ì§€ ëª»í•œ í•™ìƒì€ ì ë°œë˜ì–´ ë°˜ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.</li>
        <li>ìµœí›„ê¹Œì§€ ì ë°œë˜ì§€ ì•Šê³  ì‚´ì•„ë‚¨ì€ í•™ìƒì´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤!</li>
      </ul>
      <button class="modal-close-btn" id="modalCloseBtn">í™•ì¸</button>
    </div>
  </div>

  <script>
    const COLORS = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#d35400', '#27ae60'];
    const EMOJIS = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¤ª', 'ğŸ˜®', 'ğŸ˜‹', 'ğŸ™‚â€â†”ï¸', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜™', 'ğŸ¤–'];

    let participants = [], alivePlayers = [], eliminatedPlayers = [], winners = [], playerEmojis = {}, eliminationRounds = {}, reactionTimeouts = {};
    let gameRunning = false, gameStopped = false, currentRound = 0;

    const REASONS = {
      DANCING: "ì¶¤ì¶”ë‹¤ ê±¸ë¦¼ ğŸ’ƒ",
      CHATTING: "ë– ë“¤ë‹¤ ê±¸ë¦¼ ğŸ—£ï¸",
      SLEEPING: "ìë‹¤ ê±¸ë¦¼ ğŸ˜ª"
    };

    const $ = id => document.getElementById(id);
    const pInput = $('participants'), wCount = $('winnerCount'), wVal = $('winnerValue');
    const startBtn = $('startBtn'), resetBtn = $('resetBtn'), rList = $('rankingList');
    const sArea = $('studentsArea'), teacher = $('teacher'), bubble = $('speechBubble'), rCounter = $('roundCounter');
    const helpBtn = $('helpBtn'), helpModal = $('helpModal'), modalCloseBtn = $('modalCloseBtn'), copyResultBtn = $('copyResultBtn');

    // Storage logic
    function saveSettings() {
      localStorage.setItem('mugunghwa_participants', pInput.value);
      localStorage.setItem('mugunghwa_winnerCount', wCount.value);
    }

    function loadSettings() {
      const savedParticipants = localStorage.getItem('mugunghwa_participants');
      const savedWinnerCount = localStorage.getItem('mugunghwa_winnerCount');
      if (savedParticipants) pInput.value = savedParticipants;
      if (savedWinnerCount) {
        wCount.value = savedWinnerCount;
        wVal.textContent = savedWinnerCount;
      }
    }

    wCount.oninput = () => {
      wVal.textContent = wCount.value;
      saveSettings();
    };

    pInput.oninput = () => {
      saveSettings();
      if (!gameRunning) renderStudents();
    };

    // Standard parse function
    function parseParticipants(input) {
      const names = input.split(/[,\n]/).map(n => n.trim()).filter(n => n);
      const result = [];
      const nameCount = {};

      for (const name of names) {
        const match = name.match(/^(.+)\*(\d+)$/);
        if (match) {
          const baseName = match[1].trim();
          const count = parseInt(match[2]);
          for (let i = 0; i < count; i++) {
            nameCount[baseName] = (nameCount[baseName] || 0) + 1;
            result.push(nameCount[baseName] > 1 ? `${baseName}(${nameCount[baseName]})` : baseName);
          }
        } else {
          nameCount[name] = (nameCount[name] || 0) + 1;
          result.push(nameCount[name] > 1 ? `${name}(${nameCount[name]})` : name);
        }
      }
      return result;
    }

    function init() {
      loadSettings();
      renderStudents(true);
    }

    function renderStudents(resetEmojis = false) {
      participants = parseParticipants(pInput.value);
      alivePlayers = [...participants];
      eliminatedPlayers = [];
      winners = [];
      if (resetEmojis) playerEmojis = {};
      eliminationRounds = {};
      reactionTimeouts = {};
      currentRound = 0;
      rCounter.style.display = 'none';

      sArea.innerHTML = '';
      if (participants.length === 0) {
        rList.innerHTML = '<div style="color:rgba(255,255,255,0.4);text-align:center;padding:20px;">ì°¸ì—¬ìë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
        return;
      }

      const cols = Math.ceil(Math.sqrt(participants.length * 1.5));
      sArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      participants.forEach((name, i) => {
        const color = COLORS[i % COLORS.length];
        if (!playerEmojis[name]) {
          playerEmojis[name] = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
        }
        const emoji = playerEmojis[name];

        // Individual dance randomness
        const dur = (0.2 + Math.random() * 0.3).toFixed(2) + 's';
        const delAl = (Math.random() * -1).toFixed(2) + 's';
        const delAr = (Math.random() * -1).toFixed(2) + 's';
        const delF = (Math.random() * -1).toFixed(2) + 's';
        const delLl = (Math.random() * -1).toFixed(2) + 's';
        const delLr = (Math.random() * -1).toFixed(2) + 's';
        const delS = (Math.random() * -1).toFixed(2) + 's';
        const delH = (Math.random() * -1).toFixed(2) + 's';

        const el = document.createElement('div');
        el.className = 'student';
        el.id = `student-${i}`;
        el.style.setProperty('--dur', dur);
        el.style.setProperty('--del-al', delAl);
        el.style.setProperty('--del-ar', delAr);
        el.style.setProperty('--del-f', delF);
        el.style.setProperty('--del-ll', delLl);
        el.style.setProperty('--del-lr', delLr);
        el.style.setProperty('--del-s', delS);
        el.style.setProperty('--del-h', delH);

        el.innerHTML = `
          <div class="student-name">${name}</div>
          <div class="target-mark"></div>
          <div class="apology-bubble">ì˜ëª»í–ˆì–´ìš”..ğŸ˜­</div>
          <div class="chat-bubble">ì†Œê³¤ì†Œê³¤..ğŸ’¬</div>
          <div class="sleep-bubble">Zzz..ğŸ’¤</div>
          <div class="chair">ğŸª‘</div>
          <div class="char" style="--color: ${color}">
            <div class="c-head">${emoji}</div>
            <div class="c-body"></div>
            <div class="c-arm l"><div class="c-forearm"></div></div>
            <div class="c-arm r"><div class="c-forearm"></div></div>
            <div class="c-leg l"><div class="c-shin"></div></div>
            <div class="c-leg r"><div class="c-shin"></div></div>
          </div>
          <div class="desk-group">
            <div class="desk-top"></div>
            <div class="desk-leg l"></div>
            <div class="desk-leg r"></div>
          </div>
        `;
        sArea.appendChild(el);
      });
      updateRanking();
    }

    function updateRanking() {
      let h = '';
      winners.forEach(n => h += `<div class="ranking-item winner">ğŸ† ${playerEmojis[n]} ${n}</div>`);
      alivePlayers.forEach(n => h += `<div class="ranking-item">âœ“ ${playerEmojis[n]} ${n}</div>`);
      [...eliminatedPlayers].reverse().forEach(n => {
        const info = eliminationRounds[n] || { reason: 'ì•Œ ìˆ˜ ì—†ìŒ' };
        h += `
          <div class="ranking-item eliminated">
            <span>âœ— ${playerEmojis[n]} ${n}</span>
            <span class="reason-text">${info.reason}</span>
          </div>`;
      });
      rList.innerHTML = h || '<div style="color:rgba(255,255,255,0.4);text-align:center;padding:20px;">ì°¸ì—¬ìë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
    }

    function generateMathProblem() {
      const a = Math.floor(Math.random() * 20) + 1;
      const b = Math.floor(Math.random() * 20) + 1;
      const ops = ['+', '-'];
      const op = ops[Math.floor(Math.random() * ops.length)];
      return `${a} ${op} ${b} = ${op === '+' ? a + b : a - b}`;
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function gameLoop() {
      while (gameRunning && alivePlayers.length > parseInt(wCount.value)) {
        if (gameStopped) break;

        currentRound++;
        rCounter.textContent = `ROUND ${currentRound}`;
        rCounter.style.display = 'block';

        teacher.classList.remove('watching');
        bubble.style.display = 'block';
        bubble.textContent = '';
        bubble.style.color = '#333';

        reactionTimeouts = {};

        const aliveIndices = participants.map((n, i) => alivePlayers.includes(n) ? i : -1).filter(i => i !== -1);

        // Decide round type (0: Dancing, 1: Chatting, 2: Sleeping)
        let roundType = 0;
        if (currentRound > 1) {
          const rand = Math.random();
          if (rand < 0.33 && aliveIndices.length >= 2) roundType = 1;
          else if (rand < 0.66) roundType = 2;
          else roundType = 0;
        }

        const isPeacefulRound = (currentRound === 1 || Math.random() > 0.8);

        // Determine how many students will "break the rules"
        const maxByRatio = Math.max(1, Math.floor(alivePlayers.length / 3));
        const maxByWinners = alivePlayers.length - parseInt(wCount.value);
        const currentLimit = Math.min(maxByRatio, maxByWinners);
        const numToAct = isPeacefulRound ? Math.max(1, Math.floor(currentLimit / 2)) : (Math.floor(Math.random() * currentLimit) + 1);

        let actors = [];
        if (roundType === 1) { // Chatting
          const numPairs = Math.max(1, Math.ceil(numToAct / 2));
          for (let p = 0; p < numPairs; p++) {
            const available = aliveIndices.filter(idx => !actors.includes(idx));
            if (available.length < 2) break;
            const startPos = Math.floor(Math.random() * (available.length - 1));
            actors.push(available[startPos], available[startPos + 1]);
          }
        } else if (roundType === 2) { // Sleeping
          const shuffled = [...aliveIndices].sort(() => Math.random() - 0.5);
          actors = shuffled.slice(0, numToAct);
        } else { // Dancing
          const shuffled = [...aliveIndices].sort(() => Math.random() - 0.5);
          const numDancing = Math.max(numToAct, Math.floor(aliveIndices.length * 0.6));
          actors = shuffled.slice(0, numDancing);
        }

        // Apply initial states - strictly one behavior per round
        aliveIndices.forEach(idx => {
          const el = $('student-' + idx);
          const isActor = actors.includes(idx);

          if (isActor) {
            if (roundType === 2) {
              el.classList.add('sleeping');
              el.querySelector('.c-head').textContent = 'ğŸ˜ª';
            } else if (roundType === 1) {
              el.classList.add('chatting');
              const actorIdxInActors = actors.indexOf(idx);
              const partnerIdxInActors = actorIdxInActors % 2 === 0 ? actorIdxInActors + 1 : actorIdxInActors - 1;
              el.classList.add(idx < actors[partnerIdxInActors] ? 'chat-right' : 'chat-left');
            } else {
              el.classList.add('dancing');
            }
          }
        });

        const problem = generateMathProblem();
        const speed = Math.max(40, 150 - (10 - alivePlayers.length) * 10);

        const reactionTimes = {};
        for (let char of problem) {
          if (gameStopped) return;
          bubble.textContent += char;

          if (roundType === 1 && !isPeacefulRound && bubble.textContent.length > problem.length * 0.7) {
            break;
          }

          if (char === '=') {
            actors.forEach(idx => {
              let time;
              const isCaughtTarget = !isPeacefulRound && actors.indexOf(idx) < numToAct;

              if (isCaughtTarget) time = 1500 + Math.random() * 500;
              else time = 50 + Math.random() * 200;

              const name = participants[idx];
              reactionTimes[name] = Date.now() + time;
              reactionTimeouts[name] = setTimeout(() => {
                const el = $('student-' + idx);
                if (el) {
                  el.classList.remove('dancing', 'chatting', 'chat-left', 'chat-right', 'sleeping');
                  el.querySelector('.c-head').textContent = playerEmojis[name];
                }
              }, time);
            });
          }
          await sleep(speed + Math.random() * 40);
        }

        // --- NEW: Force sit down for anyone who hasn't started yet (e.g. early turn) ---
        actors.forEach(idx => {
          const name = participants[idx];
          if (!reactionTimes[name]) {
            const isCaughtTarget = !isPeacefulRound && actors.indexOf(idx) < numToAct;
            let time = isCaughtTarget ? 1500 : (100 + Math.random() * 400);
            
            reactionTimes[name] = Date.now() + time;
            reactionTimeouts[name] = setTimeout(() => {
              const el = $('student-' + idx);
              if (el) {
                el.classList.remove('dancing', 'chatting', 'chat-left', 'chat-right', 'sleeping');
                el.querySelector('.c-head').textContent = playerEmojis[name];
              }
            }, time);
          }
        });

        await sleep(150);

        teacher.classList.add('watching');
        bubble.style.color = "#ff4b2b";

        const catchTime = Date.now();
        const lateStudents = actors.map(idx => participants[idx]).filter(name => !reactionTimes[name] || reactionTimes[name] > catchTime);
        const toEliminate = lateStudents.slice(0, currentLimit);

        if (toEliminate.length > 0) {
          let reason = roundType === 1 ? REASONS.CHATTING : (roundType === 2 ? REASONS.SLEEPING : REASONS.DANCING);

          toEliminate.forEach(name => {
            if (reactionTimeouts[name]) clearTimeout(reactionTimeouts[name]);
            const idx = participants.indexOf(name);
            $('student-' + idx).classList.add('caught');
          });

          await sleep(400);

          const styledNames = toEliminate.map(name => `<span style="color: black;">${name}</span>`).join(', ');

          if (reason === REASONS.CHATTING) bubble.innerHTML = `ëˆ„ê°€ ì´ë ‡ê²Œ ë– ë“¤ì–´!!\n${styledNames} ì†ë“¤ê³  ë°˜ì„±í•´!`;
          else if (reason === REASONS.SLEEPING) bubble.innerHTML = `ìˆ˜ì—…ì‹œê°„ì— ì ì„ ìë‹¤ë‹ˆ!!\n${styledNames} ì¼ì–´ë‚˜ì„œ ë°˜ì„±í•´!`;
          else bubble.innerHTML = `ìˆ˜ì—… ì‹œê°„ì— ì¶¤ ê¸ˆì§€!!\n${styledNames} ì†ë“¤ê³  ë°˜ì„±í•´!`;

          toEliminate.forEach(name => {
            const idx = participants.indexOf(name);
            const el = $('student-' + idx);
            el.classList.remove('dancing', 'chatting', 'chat-left', 'chat-right', 'sleeping');
            el.classList.remove('caught');
            el.classList.add('eliminated');
            el.querySelector('.c-head').textContent = 'ğŸ˜­';
            alivePlayers = alivePlayers.filter(n => n !== name);
            eliminatedPlayers.push(name);
            eliminationRounds[name] = { reason: reason };
          });
          updateRanking();
          await sleep(2000);
        } else {
          bubble.style.color = "black";
          bubble.textContent = "ìˆ˜ì—… ì˜ ë“£ê³  ìˆêµ°ìš”.\nì¢‹ìŠµë‹ˆë‹¤. ê³„ì† ìˆ˜ì—…í• ê²Œìš”.";
          await sleep(1000);
        }
      }

      if (!gameStopped) {
        winners = [...alivePlayers];
        alivePlayers = [];
        updateRanking();
        showWinner();
      }
    }

    function showWinner() {
      bubble.style.display = 'none';
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const day = now.getDate();

      const winnersList = winners.map(w => `${playerEmojis[w]} ${w}`).join(', ');

      const overlay = document.createElement('div');
      overlay.className = 'winner-overlay';
      overlay.innerHTML = `
        <div class="certificate">
          <div class="cert-title">ìƒ ì¥</div>
          <div class="cert-award-name">ì œ 2025-ìˆ˜í•™-01í˜¸ (ëª¨ë²”ìƒ)</div>
          <div class="cert-names">ì„±ëª…: ${winnersList}</div>
          <div class="cert-content">
            ìœ„ í•™ìƒë“¤ì€ í‰ì†Œ íˆ¬ì² í•œ í•™ì—… ì •ì‹ ê³¼ ì„±ì‹¤í•œ ìì„¸ë¡œ ìˆ˜í•™ ì‹œê°„ì— ì„í•˜ì˜€ìœ¼ë©°, 
            íŠ¹íˆ ì„ ìƒë‹˜ì´ ì¹ íŒì„ í–¥í•´ ì—´ì •ì ìœ¼ë¡œ ë¬¸ì œë¥¼ í’€ì´í•˜ëŠ” ë™ì•ˆ 
            ë‹¨ í•œ ìˆœê°„ì˜ í”ë“¤ë¦¼ ì—†ì´ ì±…ìƒì„ ì§€í‚¤ë©° í•™ì—…ì— ì „ë…í•˜ì—¬ íƒ€ì˜ ê·€ê°ì´ ë˜ì—ˆìœ¼ë¯€ë¡œ 
            ì´ì— ìƒì¥ì„ ìˆ˜ì—¬í•˜ì—¬ ê·¸ ê³µë¡œë¥¼ ì¹˜í•˜í•¨.
          </div>
          <div class="cert-date">${year}ë…„ ${month}ì›” ${day}ì¼</div>
          <div class="cert-footer">ìˆ˜í•™ ì„ ìƒë‹˜ ì¼ë™ (ì¸)</div>
          <button class="cert-btn" onclick="this.parentElement.parentElement.remove()">í™•ì¸</button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function showToast(m) {
      const e = document.querySelector('.toast');
      if (e) e.remove();
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = m;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }

    copyResultBtn.onclick = () => {
      if (winners.length === 0 && eliminatedPlayers.length === 0) {
        showToast('ì•„ì§ ê²Œì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤!');
        return;
      }
      let r = 'ğŸ’ƒ êµì‹¤ì—ì„œ ì¶¤ì„! ê²°ê³¼\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
      if (winners.length > 0) r += `ğŸ† ìµœì¢… ìƒì¡´ì: ${winners.join(', ')}\n`;
      r += `ğŸ“Š ì´ ${currentRound}ë¼ìš´ë“œ ì§„í–‰\nğŸ‘¥ ì°¸ì—¬ì: ${participants.length}ëª…\n`;
      if (eliminatedPlayers.length > 0) {
        r += `âŒ íƒˆë½ì ëª©ë¡:\n`;
        eliminatedPlayers.forEach(n => {
          const info = eliminationRounds[n];
          r += `- ${n} (${info.reason})\n`;
        });
      }
      navigator.clipboard.writeText(r).then(() => showToast('ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))
        .catch(() => showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    };

    startBtn.onclick = async () => {
      if (gameRunning) return;
      const names = parseParticipants(pInput.value);
      if (names.length <= parseInt(wCount.value)) {
        alert("ì°¸ì—¬ìê°€ ìƒì¡´ì ìˆ˜ë³´ë‹¤ ë§ì•„ì•¼ í•©ë‹ˆë‹¤!");
        return;
      }
      gameRunning = true;
      gameStopped = false;
      startBtn.disabled = true;
      renderStudents();
      await sleep(500);
      gameLoop();
    };

    resetBtn.onclick = () => {
      gameStopped = true;
      gameRunning = false;
      startBtn.disabled = false;
      renderStudents(true);
      teacher.classList.remove('watching');
      bubble.style.display = 'none';
      rCounter.style.display = 'none';
    };

    helpBtn.onclick = () => helpModal.style.display = 'flex';
    modalCloseBtn.onclick = () => helpModal.style.display = 'none';
    window.onclick = (e) => { if (e.target === helpModal) helpModal.style.display = 'none'; };

    init();
  </script>
</body>

</html>